# Custom Virtual Machine Images

This folder contains files that deploy the infrastructre used to create and publish custom virtual machine (VM) images in Azure.

## Folder Structure

```text
.
├── Makefile                      # Makefile used to drive all scripts and automation
├── README.md                     # This README document
├── roles                         # Folder containing custom Azure role defintions
├── scripts                       # Folder containing bash scripts and environment settings
│   ├── environments              # Folder containing environment settings
├── templates                     # Folder containing Custom VM templates and scripts
└── utils                         # Scripts and utilities
```

## `Makefile` Targets

The `Makefile` has the following help text, which you can see if you run `make help` from the command line:

``` bash

$ make help

help                            Show this help
vm-show-env                     show the environment variables associated with custom VM images
vm-create-role                  creates the custom role defintion (run once per subscription)
vm-view-role                    views the custom role defintion
vm-deploy-core                  deploy core infra required for custom VMs (run once per environment)
vm-define-linux-image           create linux image definitions within Azure Compute Gallery
vm-define-basic-linux-image     create basic linux image definitions within Azure Compute Gallery
vm-define-windows-image         create windows image definitions within Azure Compute Gallery
vm-deploy-template-artifacts    copy VM templates and supporting scripts to storage in Azure (run when templates are updated)
vm-create-linux-template        create the linux template in Azure (run once per template)
vm-create-basic-linux-template  create the basic linux template in Azure (run once per template)
vm-create-windows-template      createthe windows template (run once per template)
vm-build-linux-image            builds the custom Linux VM image
vm-build-basic-linux-image      builds the basic Linux VM image
vm-build-windows-image          builds the custom Windows VM image

```

> Note: The dev container has bash completion for `make` set up so you can type `make vm-c` and then hit `TAB` to complete this command, or to list the possible options that match.

These make targets are ordered in the order that you will generally run them.

## Environment Set up

Before running the `Makefile` targets you need to define environment variables for your environment.

For a developer, in a person development loop (e.g. editing the customisation scripts, and testing they work) you will want to take a copy of `scripts\environments\local.env.example` and save it into the same folder as `local.env`. Then, set values for each of the environment variables that does not otherwise have a value already set.

The following is an example of how your `local.env` might look once populated with values:

``` bash
# Environment (used in naming of image definitions)
# Suggestion: replace Test01 with your email alias or something unique to you
#             e.g. Bob01
export CVM_ENVIRONMENT_SUFFIX=Test01

# Resource group and location of Azure Compute Gallery
export CVM_RESOURCE_GROUP=ouh-customvm01
export CVM_LOCATION=uksouth
export CVM_GALLERY_NAME=ouh_gallery_01

# Storage Account for VM Image Templates
export CVM_STORAGE_ACCOUNT=ouhcmvmsto01
export CVM_CONTAINER_NAME=custom-vm-assets

# Managed Identity
export CVM_IMAGE_BUILDER_ID_NAME=ouhimgbldID01

# Custom Role Definition
export CVM_IMAGE_BUILDER_ROLE_NAME="Azure Image Builder Service Image Creation Role (Dev)"
```

The `CVM_ENVIRONMENT_SUFFIX` variable is worth calling out. This prevents you from name-clashing with the Development and Production infrastructure.
If you intend to deploy your own copies of these resources then you should define a `CVM_ENVIRONMENT_SUFFIX` value that is unique to you. This will then be appended to the image template names, offer names, and image defintion names that you generate. In the Development and Productions .env files this value is not set.

### Named Environments

Within the `vm-images/scripts/environments` folder you will see named environment .env files:

| file               | description |
| ----               | ------------|
| `development.env`  | Contains the environment variables for the DEV subscription |
| `production.env`   | Contains the environemnt variables for the PROD subscription |

> NOTE: You should not use any of the files above unless you are explicity deploying the singleton DEV or PROD infrastructure for Custom VMs.
>
> The infrastructure that is generated by using these environment variables is used within PR and `main` build deployments, so take care before using these settings

## Usage

There are 5 activities that the `Makefile` and associated scripts support. These are:

1. Setting up the Infrastructure for Custom VM Builds
2. Defining an Image in Compute Gallery
3. Deploying Customisation Scripts to a Storage Account
4. Creating Image Templates
5. Building an Image Version

Each of these activities are described in more detail below.

### Activity 1 - Setting up the Infrastructure for Custom VM Builds

In order for Azure Image Builder to be able to access the resources you deploy, it needs to make use of a custom Azure role.

Use `make vm-view-role` to view details about the deployed Azure custom role. Running this target will determine if it's appropriate to run `make vm-create-role` for this subscription. If this target returns details there's no need to run `make vm-create-role`.

Use `make vm-create-role` to create a custom Azure role. You should do this **once per subscription**. Once you have run this once in a given subscription you will never need to run it again. Running it a second time won't break anything, but will return an error.

Assuming you've created the Azure custom role, you should now deploy the core infrastructure.

Use `make vm-deploy-code` to deploy the Resource Group, a Storage Account, an Azure Compute Gallery, and a Managed Identity. You should do this **once per environment** where an environment might be DEV, PROD, or a personal developer environment.

At this point, you now have the infrastructure in place to support the defintion of VM images, templates, and building VM image versions and publishing them to an Azure Compute Gallery.

### Activity 2 - Defining an Image in Compute Gallery

An image defintion, within Azure Compute Gallery, is essentially like a catalog entry; it's a way of advertising a type of image, allowing it to be discoverable.

Use `make vm-define-images` to create the image definitions within your Azure Compute Gallery.
This **only needs to be run once**, but **re-run this every time you decide to add a new image definition to the Azure Compute Gallery**.
For example, if you decide "we need to create a new type of custom VM image you would edit `vm-define-images.sh` to add your new image definition, and then re-run this make target.

### Activity 3 - Deploying Customisation Scripts to a Storage Account

When Azure Image Builder builds an Image Template (the next step) is will need to access the customisation scripts (bash or Powershell scripts). In order for this to work these scripts need to be hosted somewhere.

Use `make vm-deploy-template-artifacts` to copy these files to the storage account that was set up during Activity 1. This **only needs to be run if the customisation scripts are changed**.

### Activity 4 - Creating Image Templates

An Image Template is generated from the `image_template.json` files within this folder structure. These Image Templates tell Azure Image Builder how to build and then customize an Image Version. Each time you want to create a new Image Version you will use an Image Template.

There is a make target for each image template. Use one of the following:

```text
make vm-create-linux-template
make vm-create-basic-linux-template
make vm-create-windows-template
```

You should run these targets if you need to change your image template in some way.

### Activity 5 - Building an Image Version

Finally, an Image Version is build by running the Image Template. This causes Image Builder to take the base OS image (specified in the template), apply the customisations (specified in the template), and to publish the output to an Azure Compute Gallery. At the end of this process you will have an Image Version.

There is a make target for each building each image version from their template. Use one of the following:

```text
make vm-build-linux-image
make vm-build-windows-image
make vm-build-basic-linux-image
```

You should run these targets each time you want to generate a new Image Version. This might include building new versions to capture changes in the base OS image (e.g. patches), or capturing any changes in the customization scripts.

> Note: this step can take a very long time. The basic linux image takes around 20 mins. The other images take up to an hour, or longer, to complete.

## Templates Folder

The `templates` folder contains one folder per customized VM definition. The structre of this folder is currently (at time of writing) as follows:

```text
.
├── basic-linux
│   ├── image_metadata.txt
│   └── image_template.json
├── linux
│   ├── image_metadata.txt
│   ├── image_template.json
│   └── scripts
│       ├── init_user_profile.sh
│       └── init_vm.sh
└── windows
    ├── image_metadata.txt
    ├── image_template.json
    └── scripts
        └── init_vm.ps1
```

Within each subfolder you can find the following types of files:

Each folder contains an `image_template.json` file. This is the template that is delivered to Azure Image Builder and defines the way in which a base VM image will be customised.
The following link contains a reference for these files: <https://learn.microsoft.com/en-us/azure/virtual-machines/linux/image-builder-json?tabs=json%2Cazure-powershell>

Optionally, each folder also contains a `scripts` subfolder, and one or more scripts (Bash, Powershell, or otherwise). These scripts are referenced by the `image_template.json` file, and are accessed and run during the Azure Image Builder steps.

Finally, each folder contains an `image_metadata.txt`. This file contains name/value pairs that are used by the Custom VM scripts. It is important that each folder contains one of these metadata files, and that the file follows the same format as follows:

```ini
IMAGE_DEFINITION_PREFIX=IMAGE_DEFINITION_PREFIX_HERE
TEMPLATE_NAME_PREFIX=TEMPLATE_NAME_PREFIX_HERE
OFFER_PREFIX=OFFER_PREFIX_HERE
PUBLISHER_NAME=PUBLISHER_NAME_HERE
SKU=SKU_HERE
OSTYPE=OSTYPE_HERE
```

For example:

```ini
IMAGE_DEFINITION_PREFIX=OUHBasicLinuxImage
TEMPLATE_NAME_PREFIX=OUHBasicLinuxVM
OFFER_PREFIX=OUHBasicLinuxVM
PUBLISHER_NAME=OUH
SKU=18.04-LTS
OSTYPE=Linux
```

Property | Usage |
---|---
IMAGE_DEFINITION_PREFIX| Used as a prefix for the image defintion within Azure Compute Gallery. Suffix is the `CVM_ENVIRONMENT_SUFFIX` value from the environment `.env` file. e.g. `OUHBasicLinuxImage` prefix might be combined with `Test01` to become `OUHBasicLinuxImageTest01`
TEMPLATE_NAME_PREFIX| Used as a prefix for the template name within Azure Compute Gallery. Suffix is the `CVM_ENVIRONMENT_SUFFIX` value from the environment `.env` file. e.g. `OUHBasicLinuxVM` prefix might be combined with `Test01` to become `OUHBasicLinuxVMDev`OUHBasicLinuxVM
OFFER_PREFIX| OUHBasicLinuxVM
PUBLISHER_NAME| The publisher name used when publishing the image in Azure Compute Gallery. e.g. `OUH`
SKU| The SKU used when publishing the image in Azure Compute Gallery. e.g. `18.04-LTS`
OSTYPE| The OS type used when publishing the image in Azure Compute Gallery. Can be either `Linux` or `Windows`

## Finally

Once an Image Version has been build it is possible to create VMs based upon that Image Version. This can be done within the portal, or via the Azure CLI.


